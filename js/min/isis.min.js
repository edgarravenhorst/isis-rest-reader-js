var IsisMember=function(a){"use strict";this.method=a.links[0].method,this.url=a.links[0].href,this.isReady=!1,this.onError=function(a){return console.log(a),a}},IsisCollection=function(a){"use strict";IsisMember.call(this,a),this.getValues=function(){var a=this;return $ISIS.ajax(this.url).then(function(b){for(var c=b.value,d=0;d<c.length;d++)a.initValue(c[d]);return c})},this.initValue=function(a){a.collect=function(){return this.collectValue(a)}.bind(this)},this.extract=function(){return this.getValues().then(function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].collect());return Promise.all(b)})},this.collectValue=function(a){var b=a;return $ISIS.ajax(a.href).then(function(c){return a=$ISIS.extractMembers(c),a.rawdata=b,a})}};IsisCollection.prototype=Object.create(IsisMember.prototype),IsisCollection.prototype.constructor=IsisCollection;var IsisAction=function(a){"use strict";IsisMember.call(this,a),this.invoke=function(a){var b=this;return this.prepare().then(function(c){return $ISIS.ajax(b.url+"/invoke",{method:c.links[2].method,params:a})}).then(b.result)["catch"](function(a){400==a.status&&console.log("required parameters: ",b.requiredParams),b.onError(a)})},this.prepare=function(){var a=this;return $ISIS.ajax(this.url).then(function(b){return a.rawdata=b,a.requiredParams=b.parameters,b},a.onError)},this.result=function(a){return new Promise(function(b,c){if(!a.result.value)return void b(a);for(var d=[],e=0;e<a.result.value.length;e++){var f=a.result.value[e];d.push($ISIS.ajax(f.href))}Promise.all(d).then(function(a){if(1===a.length)b($ISIS.extractMembers(a[0]));else{var c=[];for(var d in a)c.push($ISIS.extractMembers(a[d]));b(c)}})})}};IsisAction.prototype=Object.create(IsisMember.prototype),IsisAction.prototype.constructor=IsisAction;var ISIS=function(){"use strict";this.settings={baseurl:"http://xtalus.apps.gedge.nl/simple/restful/",method:"GET"},this.init=function(a){return a=a||this.settings.baseurl,this.ajax(a).then(function(a){return new Promise(function(b,c){var d=$ISIS.extractMembers(a);b(d)})}.bind(this))},this.extractMembers=function(a){if(a.members){var b=a.members,c={};for(var d in b){var e,f=b[d];switch(f.memberType){case"collection":e=new IsisCollection(f);break;case"action":e=new IsisAction(f);break;default:e=f.value}c[d]=e}return c}},this.setCookie=function(a,b,c){var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3);var e="expires="+d.toUTCString();document.cookie=a+"="+b+"; "+e},this.getCookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(0===e.indexOf(b))return e.substring(b.length,e.length)}return""},this.deleteCookie=function(a){var b=new Date;b.setDate(b.getDate()-1),document.cookie=escape(a)+"=;expires="+b}},$ISIS=$ISIS||new ISIS;ISIS.prototype.ajax=function(a,b){"use strict";return new Promise(function(c,d){if("string"!=typeof a)return void d("url is not a string, type="+typeof a,a);b=b||{},b.method=b.method||"GET",b.headers=b.headers||{},b.format=b.format||"json",b.params=b.params||{};var e=new XMLHttpRequest;e.onreadystatechange=function(){if(e.readyState==XMLHttpRequest.DONE)if(200==e.status){var a=e.responseText;"json"==b.format&&(a=JSON.parse(a)),c(a)}else 400==e.status?(console.log("There was an error 400"),d(e)):401==e.status?(console.log("Unauthorized"),d(e)):(console.log("something else other than 200 was returned"),d(e))};var f="";for(var g in b.params)f+=""!==f?"&":"?",f+=g+"="+encodeURIComponent(b.params[g]);e.open(b.method,a+f,!0),e.setRequestHeader("Content-Type","application/json; charset=utf-8");var h=$ISIS.getCookie("auth");""!==h&&($ISIS.authHeader=h),b.headers.Authorization&&($ISIS.authHeader=b.headers.Authorization),$ISIS.authHeader&&e.setRequestHeader("Authorization",$ISIS.authHeader),"GET"===b.method,e.send()})},ISIS.prototype.auth={login:function(a,b,c){"use strict";var d={};return $ISIS.ajax($ISIS.settings.baseurl+"?time="+(new Date).getTime(),{method:"get",headers:{Authorization:"Basic "+this.base64.encode(a+":"+b)}}).then(function(c){return $ISIS.setCookie("auth","Basic "+$ISIS.auth.base64.encode(a+":"+b),5),{success:a===c.userName}},function(a){return d.message="Gebruikersnaam of wachtwoord is niet juist",d})},logout:function(){$ISIS.deleteCookie("auth")},base64:{encode:function(a){"use strict";var b,c,d,e,f,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h="",i="",j="",k=0;do b=a.charCodeAt(k++),c=a.charCodeAt(k++),i=a.charCodeAt(k++),d=b>>2,e=(3&b)<<4|c>>4,f=(15&c)<<2|i>>6,j=63&i,isNaN(c)?f=j=64:isNaN(i)&&(j=64),h=h+g.charAt(d)+g.charAt(e)+g.charAt(f)+g.charAt(j),b=c=i="",d=e=f=j="";while(k<a.length);return h},decode:function(a){var b,c,d,e,f,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(a)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do d=g.indexOf(a.charAt(k++)),e=g.indexOf(a.charAt(k++)),f=g.indexOf(a.charAt(k++)),j=g.indexOf(a.charAt(k++)),b=d<<2|e>>4,c=(15&e)<<4|f>>2,i=(3&f)<<6|j,h+=String.fromCharCode(b),64!=f&&(h+=String.fromCharCode(c)),64!=j&&(h+=String.fromCharCode(i)),b=c=i="",d=e=f=j="";while(k<a.length);return h}}};
